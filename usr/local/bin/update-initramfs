#!/bin/bash

set -e

case "$DPKG_MAINTSCRIPT_PACKAGE" in
linux-image-*)
        if [ -z "$INITRAMFS_TOOLS_KERNEL_HOOK" ]; then
                # kernel maintainer script called us directly; ignore
                # it and let the hook script handle it instead
                echo "update-initramfs: deferring update (hook will be called later)"
                exit 0
        fi
        ;;
?*)
        if         $USETRIGGERS                                         \
                && [ $# = 1 ]                                           \
                && [ x"$1" = x-u ]                                      \
                && dpkg-trigger --check-supported 2>/dev/null
        then
                if dpkg-trigger --no-await update-initramfs; then
                        echo "update-initramfs: deferring update (trigger activated)"
                        exit 0
                fi
        fi
        ;;
esac


/usr/sbin/update-initramfs $@

VER=$(uname -r)
while getopts ":k:" optname; do
	case $optname in
	k)
        	VER=$OPTARG
		;;
	esac
done

case "$DPKG_MAINTSCRIPT_PACKAGE" in
linux-image-*)
	echo "New kernel install - deferring aufs update to postinst"
	;;
*)
	/etc/kernel/postinst.d/zzz-mk-aufs-kernel $VER
	;;
esac

